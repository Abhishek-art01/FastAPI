<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Manager Dashboard</title>

    <link rel="stylesheet" href="/gps-corner-static/gps_corner.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>



<body>

    <div class="dashboard-container">

        <header class="filter-bar">
            <div class="filter-title">
                <h2>GPS Corner</h2>
                <span id="resultCount">Loading system...</span>
            </div>
            <div class="filter-inputs">
                <input type="date" id="filterDate" class="inp">
                <input type="text" id="filterCab" placeholder="Search Cab No..." class="inp">
                <input type="text" id="filterDirection" placeholder="Search Direction..." class="inp">
                <button class="btn-search" onclick="fetchTrips()">
                    <i class="fa-solid fa-magnifying-glass"></i> Search
                </button>
            </div>
        </header>

        <main id="tripsContainer" class="cards-wrapper">
        </main>

    </div>

    <div id="toast">Data Saved Successfully!</div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = "/api"; // Use relative path since frontend/backend are same origin

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchTrips();
        });

        // --- FETCH DATA ---
        async function fetchTrips() {
            const date = document.getElementById('filterDate').value;
            const cab = document.getElementById('filterCab').value;
            const container = document.getElementById('tripsContainer');
            const countLabel = document.getElementById('resultCount');

            container.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#666;">Searching records...</p>';

            try {
                let url = `${API_BASE_URL}/gps_trips?`;
                if (date) url += `date=${date}&`;
                if (cab) url += `vehicle=${cab}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error("Network response was not ok");

                const trips = await response.json();

                countLabel.innerText = `Found ${trips.length} active trips`;
                renderTrips(trips);

            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = `<p style="grid-column: 1/-1; text-align:center; color:red;">Error connecting to server.</p>`;
            }
        }

        // --- RENDER CARDS ---
        function renderTrips(trips) {
            const container = document.getElementById('tripsContainer');
            container.innerHTML = '';

            if (trips.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding: 40px; color:#888;">No "Not Pay" trips found.</p>';
                return;
            }

            trips.forEach(trip => {
                const card = document.createElement('div');
                card.className = 'trip-card';

                // Handling nulls gracefully
                const startLoc = trip.journey_start_location || '';
                const endLoc = trip.journey_end_location || '';
                const remark = trip.gps_remark || '';

                card.innerHTML = `
                    <div class="card-header">
                        <div class="header-left">
                            <span class="trip-id">Trip ID: ${trip.trip_id}</span>
                            <span class="trip-date"><i class="fa-regular fa-calendar"></i> ${trip.shift_date || ''}</span>
                            <span class="trip-cab"><i class="fa-solid fa-taxi"></i> ${trip.cab_reg_no || ''}</span>
                        </div>
                        <div class="header-right">
                             <span class="badge badge-red">ROUTE: ${trip.clubbing_status || 'NOT PAY'}</span>
                             <span class="badge badge-blue">PICKUP</span>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="emp-table-wrapper">
                            <table class="emp-table">
                                <thead>
                                    <tr>
                                        <th>EMP ID</th>
                                        <th>NAME</th>
                                        <th>ADDRESS</th>
                                        <th>LANDMARK</th>
                                        <th>STATUS</th>
                                        <th>CLUBBING</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>${trip.employee_id}</td>
                                        <td><strong>${trip.employee_name}</strong></td>
                                        <td class="addr-cell">${trip.address}</td>
                                        <td>${trip.landmark || ''}</td>
                                        <td>Not Pay</td>
                                        <td><span class="badge badge-red-light">${trip.clubbing_status}</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card-footer-yellow">
                        <div class="form-group">
                            <label>JOURNEY START</label>
                            <select id="start-${trip.trip_id}" class="form-input">
                                <option value="">-- Select --</option>
                                <option value="Office" ${startLoc === 'Office' ? 'selected' : ''}>Office</option>
                                <option value="Home" ${startLoc === 'Home' ? 'selected' : ''}>Home</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>GPS TIME</label>
                            <input type="text" class="form-input" value="12:30-14:30" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>JOURNEY END</label>
                            <select id="end-${trip.trip_id}" class="form-input">
                                <option value="">-- Select --</option>
                                <option value="Office" ${endLoc === 'Office' ? 'selected' : ''}>Office</option>
                                <option value="Home" ${endLoc === 'Home' ? 'selected' : ''}>Home</option>
                            </select>
                        </div>

                        <div class="form-group wide">
                            <label>GPS REMARK</label>
                            <input type="text" id="remark-${trip.trip_id}" class="form-input" placeholder="Remark..." value="${remark}">
                        </div>

                        <button class="btn-save" onclick="saveTrip(${trip.trip_id})">
                            <i class="fa-solid fa-floppy-disk"></i> Save
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- SAVE FUNCTION ---
        async function saveTrip(tripId) {
            const start = document.getElementById(`start-${tripId}`).value;
            const end = document.getElementById(`end-${tripId}`).value;
            const remark = document.getElementById(`remark-${tripId}`).value;

            try {
                const response = await fetch(`${API_BASE_URL}/update_gps/${tripId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        journey_start: start,
                        journey_end: end,
                        gps_remark: remark
                    })
                });

                if (response.ok) {
                    showToast("Trip Saved Successfully!");
                } else {
                    showToast("Error saving trip.");
                }
            } catch (error) {
                console.error("Save Error:", error);
                showToast("Connection Error");
            }
        }

        function showToast(message) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show";
            setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
        }
    </script>

</body>

</html>